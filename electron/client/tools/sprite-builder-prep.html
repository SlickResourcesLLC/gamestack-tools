<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HTML-CSS Test</title>


    <link rel="stylesheet" href="../assets/js/dat.gui.css">


    <script src="../assets/js/dat.gui.js"></script>

    <script src="../assets/js/Tween.js"></script>

    <script src="../dist/obj/Animation.js"></script>


    <script src="../dist/obj/Force.js"></script>

    <script src="../dist/Quazar.js"></script>



    <script src="../dist/obj/Motionstack.js"></script>


    <script src="../dist/obj/Sprite.js"></script>

    <script src="../dist/obj/GamepadAdapter.js"></script>

    <script src="../dist/script/Terrain.js"></script>

    <script src="../assets/js/dat.gui.interface.js"></script>

    <script src="../assets/js/jquery.js"></script>

    <script src="../assets/bootstrap/js/bootstrap.min.js"></script>

    <script src="../assets/js/jquery.fileDownload.js"></script>



    <link rel="stylesheet" href="../assets/js/dat.gui.css" />


    <style>
        body {
            color: #888888;
            font-family:Monospace;
            font-size:13px;
            background-color: #000;
            margin: 0px;
            overflow: hidden;

            padding:5px;

            position:absolute;

            width:100%;

            height:100%;
        }
        #info {
            position: absolute;
            top: 0px;
            width: 400px;
            left: calc(50% - 200px);
            text-align: center;
        }
        a {
            color: #00f;
        }
    </style>



    <style>
        

        canvas
        {

            position:relative;

            z-index:1;

            background:black;

            width:100%;

            height:100%;

            border:none;

            top:0px;

        }



        button.test-button
        {
            position:relative;

            background: #4c4c4c; /* Old browsers */
            background: -moz-linear-gradient(top, #4c4c4c 0%, #595959 12%, #666666 25%, #474747 39%, #2c2c2c 50%, #000000 51%, #111111 60%, #2b2b2b 76%, #1c1c1c 91%, #131313 100%); /* FF3.6-15 */
            background: -webkit-linear-gradient(top, #4c4c4c 0%,#595959 12%,#666666 25%,#474747 39%,#2c2c2c 50%,#000000 51%,#111111 60%,#2b2b2b 76%,#1c1c1c 91%,#131313 100%); /* Chrome10-25,Safari5.1-6 */
            background: linear-gradient(to bottom, #4c4c4c 0%,#595959 12%,#666666 25%,#474747 39%,#2c2c2c 50%,#000000 51%,#111111 60%,#2b2b2b 76%,#1c1c1c 91%,#131313 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#4c4c4c', endColorstr='#131313',GradientType=0 );
            color:white;

        }

        ul.controllable, ul.options
        {
            position:fixed;

            width:150px;

            z-index:990;

            left:0px;

            top:50px;

            padding:7px;

            padding-left:25px;

            border:2px inset grey;

            margin:5px;


            cursor:pointer;

            background-color: rgba(0, 0, 0, 0.6);

            font:14px Arial, Sans-Serif;


        }

        form.selected_object_edit
        {
            position:absolute;

            width:243px;

            right:0px;

            margin-top:50px;

            min-height:80px;

            border:2px inset grey;

            margin-right:15px;

        }

        form.selected_object_edit label
        {
            padding:5px;

        }


        form.selected_object_edit input
        {

            padding:5px;

        }


        #container
        {
            position:absolute;

            top:50px;

        }


        button.test
        {

            color:forestgreen;


        }

        .main
        {

           position:relative;

            top:0px;

            right:0px;

            float:right;

        }

        .selected_object
        {

            left:200px;

        }

        .options
        {


            left:420px;

        }

        span.tree-open
        {

          display:inline-block;

            width:50px;

            height:50px;

            text-align:center;


            margin-left:-20px;


            border:none;

            color:gold;

            transform: rotate(90deg);


            -ms-transform-origin: 50% 50%; /* IE 9 */

            -webkit-transform-origin:  50% 50%; /* Chrome, Safari, Opera */

            transform-origin: 50% 50%;

        }

       span.open
        {


            -o transform: rotate(180deg);

            -ms transform: rotate(180deg);

            -webkit transform: rotate(180deg);

           transform: rotate(180deg);

        }




        img.ctrl
        {

            width:18px;

            height:18px;

            background-color:black;

            border:1px solid grey;

            margin:-3px;

        }

        img.ctrl.eye
        {

            width:18px;

            height:18px;

            background-color:lightgrey;

            border:1px solid grey;

            margin:-3px;

            margin-top:-19px;

        }


        img.top-right
        {

            background-color:grey;

            border:1px solid grey;

            margin:-3px;

        }

        img.top-left
        {

            background-color:grey;

            border:1px solid grey;

            margin:-3px;

            position:absolute;

            left:0; top:0;



        }


        img.tree-add
        {

            background-color:grey;

            margin:3px;

            margin-left:-15px;

            margin-bottom:-3px;


        }

        img.ctrl:hover
        {



        }


        ul .controllable-image
        {

            width:100%;

            height:auto;

            padding:5px;

        }

        ul input[type="checkbox"]
        {

            clear:both;

            position:relative;

            float:right;


        }



        li.array_member
        {

            text-align:left;



        }


        ul>li>ul {


        }

        ul>li {

            list-style-type:none;

            display:block;

            padding:3px;

            padding-right:25px;

        }

        ul ul
        {

           padding-left:10px;

        }

        #gui-container
        {

            position:absolute;


            top:0px; right:0;

            left:0;


            width:100%;

            height:50px;

            z-index:9999;

        }

        span#floating-hint
        {
            position:fixed;

            z-index:999;

            top:0px;


            padding:4px;

            border-radius:5px;

            border:1px inset lightblue;

            color:#2a6496;

            background:silver;

            left:650px;

        }

        .bottom-ctrl
        {

            position:absolute;

            top:0px;

            right:40px;

        }



        #forceSelect
        {
            position:absolute;

            z-index:9999;

            left:0;

            top:0;

            margin:0;

            background: #4c4c4c; /* Old browsers */
            background: -moz-linear-gradient(top, #4c4c4c 0%, #595959 12%, #666666 25%, #474747 39%, #2c2c2c 50%, #000000 51%, #111111 60%, #2b2b2b 76%, #1c1c1c 91%, #131313 100%); /* FF3.6-15 */
            background: -webkit-linear-gradient(top, #4c4c4c 0%,#595959 12%,#666666 25%,#474747 39%,#2c2c2c 50%,#000000 51%,#111111 60%,#2b2b2b 76%,#1c1c1c 91%,#131313 100%); /* Chrome10-25,Safari5.1-6 */
            background: linear-gradient(to bottom, #4c4c4c 0%,#595959 12%,#666666 25%,#474747 39%,#2c2c2c 50%,#000000 51%,#111111 60%,#2b2b2b 76%,#1c1c1c 91%,#131313 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#4c4c4c', endColorstr='#131313',GradientType=0 );
            color:white;

        }

        #forceSelect option
        {

            background: black; /* Old browsers */

            color:white;

        }

        #top-gui
        {

            position:absolute;


            width:100%;

            height:40px;

            z-index:9999;

        }


    </style>


</head>
<body>



<div id="container">


    <div id="gui-container">

    </div>

</div>
<div id="info"></div>

<div id="top-gui">

    <select id="forceSelect">
        <option>Strong Gravity</option>
        <option>Medium Gravity</option>
        <option>Weak Gravity</option>

    </select>

    <img id="add_tween_stack_ctrl" class="main-add bottom-ctrl"  style="  width:35px; height:35px; background-image: url(&quot;img/add_icon.png&quot;);   background-position: center center; background-size: 100% auto;"></img>

    <img id="add_tween_stack_ctrl" class="main-play bottom-ctrl"  style="   width:35px; height:35px; background-image: url(&quot;img/play.png&quot;);   background-position: center center; background-size: 100% auto;"></img>


</div>




<span id="floating-hint">Live for today and let forever be free.</span>

<ul class="controllable selected_object"  >
    <span id="*" class="tree-open open" style="position:relative;  top:20px; left:0px; width:20px; height:20px; ">&psi;</span>
    <li>Selected Sprite:</li>
</ul>


<script>

    /*************************************
     *
     * Object Controller:
     *
     *      -How does it work:
     *          1. call controller_init(main_object) , where main_object{} has collections within
     *          2. open up and explore the objects. Delete them, test them, etc
     *          3. Alter, or change the objects at runtime, using default_object_display()
     *          OR custom_object_display()
     *
     *
     * ********************************/




    function LevelMaker(filename, settings)
    {


        return{

            topScroll:0,

            selected_image_src:{},

            discluded_sprites:[],

            assembled_sprite:{},

            lastPlantedCountRecordArray:[],

            pixelSnap:10,

            settings:settings || {

                name:filename || "myLevel",

                description:"the default level for our game",

                pixelSnap:10,

                levelSizeX:5000,

                levelSizeY:5000,

                levelSizeZ:0,

                game_scale:2.0

            },


            restoreInstance:function(sprites, settings, callback)
            {

                if(typeof(settings) == "object")
                {
                    levelMaker.settings = settings;

                }

                if(sprites instanceof Array)
                {

                   // alert('sprite []');

                    Game.sprites = sprites;

                    Quazar.each(Game.sprites, function(ix, item){

                        Game.sprites[ix] = new Sprite('', '', item);

                        if(item.selected_animation && item.selected_animation.src)
                        {

                            Game.sprites[ix].selected_animation = new Animation(item.selected_animation);



                        }


                    });


                }


                callback();


            },


            objectMemberToArray:function(object, key)
            {

                var list = [];

                for(var x in object)
                {

                    list.push(object[key]);

                }

                return list;

            },

            removeLast:function()
            {

                var number = levelMaker.lastPlantedCountRecordArray[levelMaker.lastPlantedCountRecordArray.length -1];

                for(var x = 0; x < number; x++) {

                    Game.sprites.pop();

                }
            },


            arrayToSelect:function(containerId, selectId, values)
            {

                var myDiv = document.getElementById(containerId);

                //Create array of options to be added
                var array = values;

                //Create and append select list
                var selectList = document.createElement("select");
                selectList.id = selectId;
                myDiv.appendChild(selectList);

                //Create and append the options
                for (var i = 0; i < array.length; i++) {
                    var option = document.createElement("option");
                    option.value = array[i];
                    option.text = array[i];
                    selectList.appendChild(option);
                }

            }

            ,

            htmlSettings:function()
            {
                var obj = levelMaker.settings;

                $('#map_name').val(obj.name);
                $('#map_description').val(obj.description);
                $('#map_type').val(obj.type);



                $('#map_snap_size').val(obj.pixelSnap + 'px');

                $('#map_level_size_x').val(obj.levelSizeX);
                $('#map_level_size_y').val(obj.levelSizeX);

                $('#map_game_scale').val(obj.game_scale);

            },

            applySettings:function(data)
            {

                if(typeof(data) == 'string')
                {
                    data = JSON.parse(data).settings;

                };


                if(!data) {

                    data ={};

                    data.name =  $('#map_name').val();

                    data.description =  $('#map_description').val();

                    data.type = $('#map_type').val();;

                    data.pixelSnap = parseFloat($('#map_snap_size').val().replace('px', ''));

                    data.levelSizeX = parseInt($('#map_level_size_x').val());

                    data.levelSizeY = parseInt($('#map_level_size_y').val());



                }

                levelMaker.settings = data;

                $('.level-maker-canvas').width(data.levelSizeX);
                $('.level-maker-canvas').height(data.levelSizeY);


                Game.canvas.width = data.levelSizeX;

                Game.canvas.height = data.levelSizeY;



                $('#map-item-space form').hide('slow');

            },

            showObjectDialog:function(){

                $('#map-item-space form').show();


            },

            objectMakerFormEvents:function()
            {

                levelMaker.assembled_sprite = new Sprite();

                App.setMotionVectorGui();

                $('#create_object').click(function(){

                    var   fx  =  parseFloat($('#frameX').val()),

                        fy  =  parseFloat($('#frameY').val()),

                        w = parseFloat($('#width').val()),

                        h =  parseFloat($('#height').val()),

                        fw  =  parseFloat($('#framewidth').val()),

                        fh  =  parseFloat($('#frameheight').val());


                    var name = $('#name').val(),

                        type = $('#type').val(),

                        description = $('#description').val(),

                        id = $('#id').val(),

                        image_data = $('#image_data').val();

                    //alert('Creating Map Object');

                    levelMaker.selected_image_src = image_data;

                    console.log('Making objects in create event');

                    var args = {type:type, description:description };


                    args.size = new Vector3(w, h, 0);


                    levelMaker.selectedSprite = levelMaker.MapElement(name, levelMaker.selected_image_src, new Vector3(fw, fh, 0), new Vector3(w, h, 0),
                        args );

                    levelMaker.selectedSprite.img.onload = function()
                    {

                        levelMaker.addLevelObjectToUI( levelMaker.selectedSprite);

                    }

                    $('#map-item-space form').hide();

                });


                $("#object-maker input").change(function(evt)
                {

                    var   fx  =  parseFloat($('#frameX').val()),

                        fy  =  parseFloat($('#frameY').val()),

                        w = parseFloat($('#width').val()),

                        h =  parseFloat($('#height').val()),

                        fw  =  parseFloat($('#framewidth').val()),

                        fh  =  parseFloat($('#frameheight').val());


                    levelMaker.sizeImage(fx, fy, w, h, fw, fh);


                });

            },

            sizeImage:function(frameX, frameY, mapWidth, mapHeight,  frameWidth, frameHeight)
            {

                var canvas = document.getElementById('testCanvas');

                var ctx = canvas.getContext('2d');

                var image = $(canvas).parent().find('img')[0];

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                var x = 0, y = 0;


                var width = mapWidth, height = mapHeight;

                var portion = mapWidth / mapHeight;

                mapHeight = canvas.height;

                mapWidth = mapHeight * portion;

                x = (canvas.width / 2) - mapWidth / 2;

                y = (canvas.height / 2) - mapHeight / 2;

                $('#frameX').val(frameX);

                $('#frameY').val(frameY);

                $('#width').val(width);

                $('#height').val(height);

                $('#framewidth').val(frameWidth);



                $('#frameheight').val(frameHeight);


                ctx.drawImage(image, frameX, frameY, frameWidth, frameHeight,x, y, mapWidth, mapHeight);


            },

            getRawImageFile:function(input, callback)
            {

               // var preview =  $(input).parent().find('img')[0];
                var file  = input.files[0];
                var reader  = new FileReader();

                reader.addEventListener("load", function () {
                 //   preview.src = reader.result;

                 //   levelMaker.selected_image_src = preview.src;

                 //   $('#image_data').val(reader.result);

                    if(typeof(callback) == 'function')
                    {
                        callback(reader.result);

                    }

                }, false);

                if (file) {
                    reader.readAsDataURL(file);
                }


            },


            getRawLevelFile:function(input, callback)
            {

                var filename = $(input).val().split('\\').pop();

                if(filename.toLowerCase().indexOf('.json') >= 0)
                {

                    var file  = input.files[0];
                    var reader  = new FileReader();

                    reader.addEventListener("load", function () {

                        callback(reader.result)

                    }, false);

                    if (file) {
                        reader.readAsText(file);
                    }

                }
            },



            MapData:function(map, settings)
            {

                return {map:map, settings:settings};
            },



            selection_sprite: {},
            mouse: {
                x: 0, y: 0,

                down:false

            },
            getDocHeight: function () {
                var D = document;
                return Math.max(
                    D.body.scrollHeight, D.documentElement.scrollHeight,
                    D.body.offsetHeight, D.documentElement.offsetHeight,
                    D.body.clientHeight, D.documentElement.clientHeight
                )
            },
            scrollAdjust: function () {
                var winheight = window.innerHeight || (document.documentElement || document.body).clientHeight
                var docheight = levelMaker.getDocHeight();
                var scrollTop = window.pageYOffset || (document.documentElement || document.body.parentNode || document.body).scrollTop
                var trackLength = docheight - winheight
                var pctScrolled = Math.floor(scrollTop / trackLength * 100) // gets percentage scrolled (ie: 80 or NaN if tracklength == 0)
                console.log(pctScrolled + '% scrolled');


                levelMaker.topScroll = Game.canvas.height * (pctScrolled / 100);

                return Game.canvas.height * (pctScrolled / 100);

            },
            mapElements: [],
            get: function (tag)
            {
                if(!tag)
                {
                    return this.mapElements[0];

                }

                for (var x = 0; x < this.mapElements.length; x++)
                {

                    if (this.mapElements[x].tag.toLowerCase() === tag.toLowerCase())
                    {

                        return this.mapElements[x];
                    }

                }

            },
            MapElement: function (tag, imgPath, frameSize, mapSize, extras)
            {
                var img = document.createElement('IMG');
                img.src = imgPath;

                // alert("El image:" + JSON.stringify(img.src));

                var element = {
                    tag: tag, img: img, src:imgPath, frameSize: frameSize, mapSize: mapSize

                };

                for(var x in extras)
                {
                    element[x] = JSON.parse(JSON.stringify(extras[x]));

                };


                this.mapElements.push(element);


                return element;

            },
            selectedSprite: false,
            selectedTag: "",
            selectedElement: {},
            levelObjects: [],
            deselectAll: function ()
            {

                Quazar.each(Game.sprites, function (ix, item) {

                    item.selected = false;

                    item.hover_selected = false;

                });
            },
            getSelected: function ()
            {

                var getSpr = false;

                Quazar.each(Game.sprites, function (ix, item) {

                    if (item.hover_selected || item.selected)
                    {

                        getSpr = item;

                    }

                });


                return getSpr;

            },

            centerPos:function(sprite, x, y)
            {
                sprite.position.x = Math.floor(x - sprite.size.x / 2);
                sprite.position.y = Math.floor(y - $(Game.canvas).offset().top - sprite.size.y / 2);

                sprite.position.x = sprite.position.x - ( sprite.position.x % levelMaker.settings.pixelSnap);

                sprite.position.y = sprite.position.y - ( sprite.position.y % levelMaker.settings.pixelSnap);


            },

            moveSelected: function (x, y)
            {

                Quazar.each(Game.sprites, function (ix, item) {

                    if (item.selected)
                    {

                        var x1 = x - (x% levelMaker.settings.pixelSnap) ,
                            y1 = y - (y  % levelMaker.settings.pixelSnap);


                        levelMaker.centerPos(item, x1, y1);

                    }

                });
            },

            leftClickExtra:function()
            {


            },

            leftClick: function (x, y)
            {

                //  alert('left click');

                if(typeof(this.leftClickExtra) == 'function')
                {
                    this.leftClickExtra();

                    this.leftClickExtra = false;

                    return false;

                };

                var notSelection = function(obj)
                {
                    return obj !== levelMaker.hover_selection_sprite &&

                        obj !== levelMaker.selection_sprite;

                };



                var selection = false;
                Quazar.each(Game.sprites, function (ix, item) {


                    if (notSelection(item) && x > item.position.x && x < item.position.x + item.size.x &&
                        y > item.position.y && y < item.position.y + item.size.y + $('.level-maker-canvas').offset().top)
                    {

                        item.selected = true;
                        selection = true;
                    }

                });

                if (!selection)
                {

                    levelMaker.plantMapSprite(levelMaker.selectedElement, x - (x % levelMaker.settings.pixelSnap), y - (y % levelMaker.settings.pixelSnap))

                    levelMaker.lastPlantedCountRecordArray.push(1);
                }

            },
            hoverSelect: function (x, y)
            {

                var selection = false, basic_selection = false;

                Quazar.each(Game.sprites, function (ix, item) {

                    if(item.selected )
                    {
                        basic_selection = true;

                    }

                });

                Quazar.each(Game.sprites, function (ix, item) {

                    if ( x > item.position.x && x < item.position.x + item.size.x &&
                        y > item.position.y && y < item.position.y + item.size.y + $('.level-maker-canvas').offset().top)
                    {

                        //  item.hover_selected = !basic_selection && !item.selected ?  true : item.hover_selected;
                        //   selection = true;
                    }

                });


                if (!selection && !(levelMaker.mouse.down) ) {
                    levelMaker.deselectAll()
                }
                ;


            },
            rightClick: function (x, y)
            {
                Quazar.each(Game.sprites, function (ix, item) {

                    if (x > item.position.x && x < item.position.x + item.size.x &&
                        y > item.position.y && y < item.position.y + item.size.y)
                    {

                        var ix = Game.sprites.indexOf(item);
                        Game.sprites.splice(ix, 1);
                    }


                });
            },

            simpleMapObject:function(object, x, y)
            {


                var x = Math.floor(x - object.size.x / 2);
                var y = Math.floor(y - $(Game.canvas).offset().top - object.size.y / 2);

                x = x - ( object.position.x % levelMaker.settings.pixelSnap);

                y = y - ( object.position.y % levelMaker.settings.pixelSnap);


                return {size: new Vector3(object.size.x, object.size.y, 0), position: {x: x, y: y}};

            },

            createMapSprite:function(mapElement, x, y)
            {

                // console.log("Selected Element:" + JSON.stringify(mapElement));
                var img = mapElement.img;
                console.log("Img src:" + img.src);
                var sprite = new Sprite('MapElement', 'A level-builder element');

                sprite.active = true;

                sprite.size = mapElement.mapSize;

                mapElement.src = img.src;


                var fs = mapElement.frameSize;

                sprite.setAnimation(new Animation({src:img, frameSize:fs, frameBounds:new VectorBounds(new Vector3(0, 0), new Vector3(0, 0))}));



                // console.log(JSON.stringify(sprite));

                sprite.position.x = Math.floor(x - sprite.size.x / 2);
                sprite.position.y = Math.floor(y - $(Game.canvas).offset().top - sprite.size.y / 2);

                sprite.position.x = sprite.position.x - ( sprite.position.x % levelMaker.settings.pixelSnap);

                sprite.position.y = sprite.position.y - ( sprite.position.y % levelMaker.settings.pixelSnap);

                this.selectedSprite = sprite;

                return sprite;

            },

            plantMapSprite: function (mapElement, x, y)
            {

                // console.log("Selected Element:" + JSON.stringify(mapElement));
                var img = mapElement.img;
                //  console.log("Img src:" + img.src);


                if(levelMaker.assembled_sprite.speed)
                {

                    alert(JSON.stringify(levelMaker.assembled_sprite.speed));

                }

                var sprite = new Sprite('MapElement', 'A level-builder element', JSON.parse(JSON.stringify(levelMaker.assembled_sprite)));

                sprite.active = true;

                sprite.size = mapElement.mapSize;


                if(sprite.speed)
                {

                    alert("sprite-speed:" + JSON.stringify(sprite.speed));

                }


                var fs = mapElement.frameSize;

                sprite.setAnimation(new Animation({src:img, frameSize:fs, frameBounds:new VectorBounds(new Vector3(0, 0), new Vector3(0, 0))}));



                // console.log(JSON.stringify(sprite));

                sprite.position.x = Math.floor(x - sprite.size.x / 2);
                sprite.position.y = Math.floor(y - $(Game.canvas).offset().top - sprite.size.y / 2);

                sprite.position.x = sprite.position.x - ( sprite.position.x % levelMaker.settings.pixelSnap);

                sprite.position.y = sprite.position.y - ( sprite.position.y % levelMaker.settings.pixelSnap);

                this.selectedSprite = sprite;

                sprite.def_update = function(){}; //turn off the motion, we are just mapping


                Game.sprites.push(sprite);


            },
            simulateVerticalMouseMove: function (top) {


                levelMaker.moveSelected(levelMaker.mouse.x, top);
            },

            placeGroup : function(x1, y1, dist, n, north, south, east, west)
            {



                for(var x = 0; x < n; x++)
                {

                    var x2 = 0, y2 = 0;

                    if(east){    x2 = x * levelMaker.selectedElement.mapSize.x  * -1; }

                    if(west){    x2  = x * levelMaker.selectedElement.mapSize.x   }

                    if(north){    y2 =  x * levelMaker.selectedElement.mapSize.y  * -1 }

                    if(south){    y2 =  x * levelMaker.selectedElement.mapSize.y; }

                    levelMaker.plantMapSprite(levelMaker.selectedElement, x1+ x2, y1+y2);

                    levelMaker.lastPlantedCountRecordArray.push(n - 1);

                }

            },


            addLevelObjectToUI:function(item)
            {

                App._UI_OPTION_MAP.my_objects.push(UI_Funx.OptionActionList(item.tag, item, function (err, element) {
                    console.log('1');

                    var value = $(element).text();

                    // alert('click on:' + value);

                    levelMaker.selectedElement = levelMaker.get(value);

                }));

            },

            url_prefix:'../assets/builder/'
        }

    };



    var jstr = function(obj){

        return JSON.stringify(obj);

    };


    var Game = {

        GameWindow:{},

        canvas:{},

        ctx:{},

        collective_physics:{},

        sprites:[],

        is_init:false,


        centerPos:function(sprite)
        {

            sprite.position.x = Game.WIDTH / 2 - sprite.size.x / 2;
            sprite.position.y = Game.HEIGHT / 2 - sprite.size.y / 2;

        },



        size:function(width, height)
        {

            if(typeof(width) == 'string')
            {

                alert('str r');

                width = parseFloat(width);

            }

            if(typeof(height) == 'string')
            {

                alert('str r');

                height = parseFloat(height);

            }


            this.WIDTH = width;

            this.HEIGHT = height;



            this.canvas.width = width;

            this.canvas.height = height;


        },


        update:function()
        {

            Game.selected_force.gravitateY();

        },

        render:function()
        {

            this.update();

            console.log('render');

            this.GameWindow.update();

            this.GameWindow.draw();

        },



        init:function()
        {

            $('#container').append("<canvas></canvas>");

            // 1. demonstrate that the threejs canvas can be intercepted at runtime

            this.canvas = document.getElementsByTagName('CANVAS')[0];

            this.ctx = this.canvas.getContext('2d');


            //3. the player sprite


            this.player = new Sprite('Samus-Like Character', 'a video game sprite', {
                position: new Vector3(100, 120),
                size: new Vector3(50, 52)
            });


            this.player.jump_anime = new Animation({
                src: "image/samus2.png",
                delay: 7,
                frameSize: new Vector3(50, 50, 0),
                frameBounds: new VectorBounds(new Vector3(0, 0, 0), new Vector3(4, 0, 0))
            });


this.player.jumpmotion = new Motionstack({

    name:"jump",

    description:"the jump movmement.",

    object_id:this.player.id,
    name:"jump",

    distance:new Vector3(0, -200, 0),
    curve:TWEEN.Easing.Bounce.InOut,
    line:false,
    dispersionAngle:0,
    duration:400,
    delay:0,
    delayPerMember:0
        });


            this.player.selected_motionstack = new Motionstack(this.player.jumpmotion);

            this.player.animations.push(this.player.jump_anime);

            this.player.motionstacks.push(this.player.jumpmotion);


            this.player.selected_animation = new Animation( this.player.jump_anime);



            this.player.update = function()
            {



                this.selected_animation.animate();


            };


            this.player.active = true;

            this.sprites.push(this.player);

            $('canvas').width(500);

            $('canvas').height(500);


            this.canvas.width = 500;

            this.canvas.height = 500;


            this.WIDTH = 500;

            this.HEIGHT = 500;

            Game.forceProfile = {};

            Game.forceProfile.forces = [];



            var wgrav = new Force({
                name:"weak_grav",

                accel:1.3,

                max:new Vector3(0, 5, 0),
                subjects:[Game.sprites[0]],

                massObjects:[new VectorBounds(new Vector3(-3000, 300, -3000), new Vector3(-3000, 400, 3000))]

            });

            Game.forceProfile.forces.push(wgrav);


            var mgrav = new Force({

                name:"medium_grav",

                accel:1.3,

                max:new Vector3(0, 5, 0),
                subjects:[Game.sprites[0]],

                massObjects:[new VectorBounds(new Vector3(-3000, 300, -3000), new Vector3(-3000, 400, 3000))]

            });

            Game.forceProfile.forces.push(mgrav);

            var sgrav = new Force({

                name:"strong_grav",

                accel:1.3,

                max:new Vector3(0, 5, 0),
                subjects:[Game.sprites[0]],

                massObjects:[new VectorBounds(new Vector3(-3000, 300, -3000), new Vector3(-3000, 400, 3000))]

            });

            Game.forceProfile.forces.push(sgrav);


            Game.selected_force = Game.forceProfile.forces[0];

            $('#forceSelect').change(function(evt){

                var ix = evt.target.selectedIndex;

                Game.selected_force =   Game.forceProfile.forces[ix];

                alert('changed to:' + ix + Game.selected_force.name);

            });




            this.GameWindow = new GameWindow({canvas:this.canvas, ctx: this.ctx, sprites: this.sprites, forces: this.forces}, function(){

                console.log('Game Update passed');

            });


            this.centerPos(this.sprites[0]);

            this.is_init = true;


        }

    };



    var levelMaker = LevelMaker(false);


    /******************
     *
     * App:
     *
     *   renderObjectControllable:()
     *          @devplans / todo : 1st make the functionality work, then incorporate runtime settings for controllable
     *
     *
     *
     * **********************/




    var App = {

        locked:false,


        onType:function(obj, type, callback)
        {

            if(obj instanceof type)
            {

                callback();

            }

        },


        lock_events:function()
        {
          this.locked = true;

          var _a = this;

          window.setTimeout(function(){

              _a.locked = false;

          }, 100);

        },

        hint:function(element, hintText)
        {

            var hint = $('#floating-hint');

            var enter = function(evt)
        {

            $(hint).css('left', evt.clientX + 150);

            $(hint).css('top', evt.clientY - 15);

            $(hint).text(hintText);

            $(hint).show('fast');

        },
            out = function()
            {

                $(hint).hide('fast');
            };


            $(element).hover(enter, out);

        },

        getArg:function(args, key, fallback)
        {
            return args[key] || fallback;

        },

        applyControl:function(args)
        {

            console.log('Found item');

            var parent = this.getArg(args, 'parent', false),

                id =  this.getArg(args, 'id',  false),

                html = this.getArg(args, 'html',  false),

                callback = this.getArg(args, 'callback', false),

                clName = $(parent).attr('class'),
                list = this.getArg(args, 'list', false);


            if(parent, id, html, callback) {

                $(html).insertBefore(parent);

                var clName = $(parent).attr('class');


                $('#' + id).unbind().click(function(){

                    callback(list, clName);

                });


                this.hint($('#' + id)[0], 'Add ' + clName + ' to GTUI');


            }


        },

        listToUL:function(keyname, list, iconHtmls)
        {

            var html = "<li >" + keyname + "<ul>";

            if(!iconHtmls instanceof Array)
            {
                iconHtmls = [];

            }



            $.each(list, function(ix, item){

                var icons = [];

                icons = icons.concat(iconHtmls);



                if((ix + '').indexOf('__') == -1) {

                    var name = item.name || ix;

                    $.each(icons, function(ix, str){ icons[ix] = str.replace('*', name) });


                    html += "<li class='"+keyname+"_member'>" + name + icons.join(' ') + "</li>";

                }

            });

            return html + "</ul></li>";

        },


      


        GTUI:{

            files:[],

            fileOptions:function(key, callback)
            {

                switch(key)
                {




                }


            },



            Option:function(value, args, eventKeyCall)
            {
              this.value = value;

              this.callback = eventKeyCall;

              var checkBox = args.checkable ? '<input type="checkbox"  />' : '';

              this.element = $('<li>'+value+ checkBox + '</li>');


              var _e = this.element;

              $(this.element).click( function()
              {

                  if(!this.checked)
                  {
                      this.checked = true;

                  }
                  else
                  {
                      this.checked = false;
                  }

                  eventKeyCall('click', _e);

              });

              $(this.element).hover(function(){ eventKeyCall('hover', _e); }, function(){ eventKeyCall('mouseout', _e);  });


              this.appendTo = function(parent)
              {
                  $(parent).append($(this.element));

              };

            },


            renderOptions:function(args)
            {

                var isCheckType = App.getArg(args, 'type', 'check'),

                    x = 200, y = 200,

                    parent = App.getArg(args, 'parent', []),

                    options = App.getArg(args, 'options', []) ;

                    var optionElement = $('.options')[0];

                    var _inst = this, html = '';


                $(optionElement).html('');

                    $.each(options, function(x, e){

                       e.appendTo(optionElement);

                    });

                $(optionElement).css('left', x);

                $(optionElement).css('top', y);

                $(optionElement).show();

                $(optionElement).animate({

                    'left': x,
                    'top': y,
                }, 500, function() {

                });

            },

            __selectedObject:{},

            listmemberkeys:['animations', 'motionstacks', 'forces'],

            renderObjectControllable:function(object_members, container, options)
            {

                var html = "";

                $.each(object_members /*This is where our 'MainGame' Object would go*/, function(ix, element_object){

                   if(App.GTUI.listmemberkeys.indexOf(ix) >= 0)
                   {
                       alert(ix);


                    if(ix === 'frames')
                    {
                        alert('frame element');

                    }

                    if((!element_object) || (typeof(ix) == 'string' &&  ix.indexOf('__') >= 0))
                        {
                            return;
                        }

                    var element =  element_object instanceof Array ? element_object : element_object.hasOwnProperty('list') && element_object.list  instanceof Array ? element_object.list : element_object;

                    if(element instanceof Array ) {

                      //  alert('processing array of len:' + element.length);

                        var eye_icon = '<img data-name="*"  class="tree-edit ctrl eye xcl__" style="visibility: hidden; position:absolute; right:2px; background-image: url(&quot;img/eye_icon.png&quot;);   background-position: center center; background-size: 100% auto;"></img>';
                        var cross_icon = '<img data-name="*"  class="tree-delete ctrl xcl__" style=" visibility: hidden; position:absolute; right:25px;    background-image: url(&quot;img/cross_icon.png&quot;);   background-position: center center; background-size: 100% auto;"></img>';

                        html += '<ul class="' + ix + '">' + App.listToUL(ix, element /*INSERT Members of actual array(s)*/, [eye_icon, cross_icon]) + '</ul>';

                    }


                    else if(App.GTUI.listmemberkeys.indexOf(ix) >= 0)
                    {


                        var eye_icon = '<img data-name="*" class="tree-edit ctrl eye xcl__"  style="visibility: hidden; position:absolute;  right:2px;  background-image: url(&quot;img/eye_icon.png&quot;);   background-position: center center; background-size: 100% auto;"></img>';
                        var cross_icon = '<img data-name="*"  class="tree-delete ctrl xcl__" style="visibility: hidden; position:absolute; right:25px;  background-image: url(&quot;img/cross_icon.png&quot;);   background-position: center center; background-size: 100% auto;"></img>';


                        html += '<ul class="' + ix + '">' + App.listToUL(ix, element /*INSERT Members of actual array(s)*/, [eye_icon, cross_icon]) + '</ul>';



                    }


                   }
                    
                });

                var mainElement = $(container);

                if($(container).length < 1) {

                  mainElement = $('.controllable')[0];


                }

                $(mainElement).find('img,ul').remove();

                $(mainElement).append(html);

                $.each(object_members /*This is where our 'MainGame' Object would go*/, function(ix, element_object){

                    if((!element_object) || (typeof(ix) == 'string' &&  ix.indexOf('__') >= 0))
                    {
                        return;
                    }


                    var element = element_object instanceof Array ? element_object : element_object.list  instanceof Array ? element_object.list : element_object;



                    var  add_button_html= '<img id="*" class="tree-add ctrl"  style="position:relative;  top:20px; left:0px; width:15px; height:15px; background-image: url(&quot;img/add_icon.png&quot;);   background-position: center center; background-size: 100% auto;"></img>';

                    var my_id = ix + '_add';


                    var nameElement = ix; //always should be the name of the variable

                    add_button_html = add_button_html.replace('*', my_id);


                    var relationals = ['action'];

                    var object_watch = App.GTUI.listmemberkeys;

                    var relMode = false, proceed = false;

                    Quazar.each(relationals, function(ir, item){

                        if(ix !== '' && ix && item.indexOf(ix) >= 0) //the relational key contains text of non-empty object key
                        {
                            proceed = true;
                            relMode = true;

                        }
                    });


                    Quazar.each(object_watch, function(io, item){

                        if(ix !== '' && ix && item.indexOf(ix) >= 0) //the object_watch key contains sought after text
                        {
                            proceed = true;

                        }
                    });




                    if(proceed || element instanceof Array ) {

                        App.applyControl({parent:$('.' + ix /*The class previously inserted*/), clName:ix, list:element,
                        id: my_id,html: add_button_html,
                        callback:function(list, clName){

                            App.lock_events();

                            var instantiator;

                            var tp_inst = false;


                            if(element instanceof  Array )
                            {
                                instantiator =  element[0] && element[0].constructor ? element[0].constructor.name : false;

                            }
                            else
                            {
                               tp_inst = element.hasOwnProperty('__typeProfile') ? element.__typeProfile.__key : instantiator;

                               instantiator = tp_inst;

                            }



                            var addElement = function() {

                                if (element instanceof (Array)) {


                                    element.push(myNewObject);

                                    renderListMembers(element, clName);


                                }
                                else if (typeof(element) == 'object') {

                                    alert('click on element:' + clName + ':with members::' + jstr(element));

                                    var done = false;

                                    var x = 0;

                                    while (!done && x < 200) {

                                        x++;

                                        if (!element['instance_' + x]) {

                                            element['instance_' + x] = myNewObject;
                                            done = true;
                                        }

                                    }

                                    renderListMembers(element, clName);

                                }

                            }

                            if(window[instantiator]) {

                               // alert('adding the object');

                                 myNewObject = new window[instantiator](element[0]);

                                addElement();

                            }


                        }



                        });

                    }


                    var arrayListEvents = function(list, clName) {

                      //  alert('showing array for:' + clName + ":" + list);

                        var lix = 0;

                        $.each($('.' + clName + ' li ul li'), function (ix, el) {

                            //distinguish a callback for displaying the element

                            var member = list[ix];

                            lix+= 1;

                            //we have: 1. The selected class

                            var cl = $(el).attr('class').replace('_member', '');


                            console.log(list + ' :li click');

                            var prevent = false;

                            $(el).on('click', function () {

                                // alert('click on' + list + "::" + (ix - 1));

                                //get reference to the object

                                if(Game.GameWindow[clName] && Game.GameWindow[clName].list) {

                                    //apply the top level object::

                                    var object = Game.GameWindow[clName].list[ix] || false;

                                    //  alert('Got click on object:' + jstr(object));

                                    if (object) {


                                        App.GTUI.__selectedObject = object;

                                        DatGui.get(App.GTUI.__selectedObject, ix);

                                        App.GTUI.renderObjectControllable(object, $('.selected_object')[0]);


                                    }


                                }
                               else if(!prevent)
                                {
                                    prevent = true;

                                    window.setTimeout(function(){

                                        prevent = false;

                                    },100);

                                    $(this).find('.tree-edit').click();

                                }


                            });

                            $(el).hover(function () {

                                $(this).css('background-color', '#003366');

                                $(this).css('color', 'white');

                            }, function () {

                                $(this).css('background-color', 'black');

                                $(this).css('color', 'white');

                            });

                        });

                    };



                    var renderListMembers = function(list, clName) {

                       // alert('showing array for:' + clName + ":" + list);


                           // alert('processing array');

                       var eye_icon = '<img id="*" class="tree-edit ctrl eye" style=" visibility: hidden; position:absolute; right:5px;    background-image: url(&quot;img/eye_icon.png&quot;);   background-position: center center; background-size: 100% auto;"></img>';
                       var cross_icon = '<img id="*" class="tree-delete ctrl" style="position:absolute; right:25px; background-image: url(&quot;img/cross_icon.png&quot;);   background-position: center center; background-size: 100% auto;"></img>';

                      html = App.listToUL(clName, list /*INSERT Members of actual array(s)*/, [eye_icon, cross_icon]) + '</ul>';


                       var container =  $('.' + clName);

                       $(container).html( html);




                        arrayListEvents(list, clName);

                     };

                    arrayListEvents(element, ix);

                    
                });

                return html;

            },


            renderCheckables:function(checkables, clickCallback)
            {

                var defOptionCall = function(evt_key, target)
                {

                    switch(evt_key)
                    {
                        case "hover":

                            $(target).css('background-color', '#003366');

                            $(target).css('color', 'white');

                            break;

                        case "mouseout":

                            $(target).css('background-color', 'black');

                            $(target).css('color', 'white');

                            break;

                        case "click":

                            clickCallback();

                            alert('clicked');

                            break;

                    }

                };




                var Option = App.GTUI.Option;

                var checks = [];

                if(typeof(checkables) == 'object') {

                        Quazar.each(checkables, function(ix, item){

                        checks.push( new Option(item.name, {checkable:true}, defOptionCall));

                        });

                        }



                App.GTUI.renderOptions({type:'basic',
                    options:checks});




            },

            renderByType:function(object_members, title, x, y)
            {

                var html = "";

                var testMembers = ["1", "2", "3", "4"];

                $.each(object_members /*This is where our 'MainGame' Object would go*/, function(ix, element){


                    var eye_icon = '<img id="*" class="tree-edit ctrl eye" style="position:relative;  top:2px; right:-30px;  background-image: url(&quot;img/eye_icon.png&quot;);   background-position: center center; background-size: 100% auto;"></img>';
                    var cross_icon = '<img id="*" class="tree-delete ctrl" style="position:relative;  top:2px; right:-30px;  background-image: url(&quot;img/cross_icon.png&quot;);   background-position: center center; background-size: 100% auto;"></img>';

                    html +=  '<ul class="'+element+'">' + App.listToUL(ix, element /*INSERT Members of actual array(s)*/, [eye_icon, cross_icon]) + '</ul>';

                });


                 if($('.controllable').length <= 1 ){$('body').append('<ul class="controllable"></ul>')};

                var mainElement = $('.controllable')[1];

                $(mainElement).html('<li>'+title+'</li>');

                $(mainElement).append(html);


                $(mainElement).animate({

                    'left': x,
                    'top': y,
                }, 500, function() {

                });

                $(mainElement).show('fast');

                $.each(object_members /*This is where our 'MainGame' Object would go*/, function(ix, element){

                    var  add_button_html= '<img id="*" class="tree-add ctrl" style="position:relative;  top:20px; left:0px; width:15px; height:15px; background-image: url(&quot;img/add_icon.png&quot;);   background-position: center center; background-size: 100% auto;"></img>';

                    var my_id = object_members[ix] + '_add',

                        elementText = element; //always must equal the member name

                    add_button_html = add_button_html.replace('*', my_id);

                    App.applyControl({parent:$('.' + element /*The class previously inserted*/),
                        id: my_id,html: add_button_html,
                        callback:function(object){

                            //   alert('event for: add ' + element);

                            switch(elementText)
                            {

                                /*HOW DO WE ADD EACH OF THESE AS SUB-OBJECT TO AN OBJECT?*/

                                case "animations":

                                    //how do we update an animation?

                                    DatGui.get(object, $('#floating-dat-gui'));

                                    break;


                                case "images":

                                    DatGui.get(object, $('#floating-dat-gui'));

                                    break;

                                case "sounds":

                                    break;


                                case "actions":

                                    break;

                            }


                        }});




                    $.each($('.' + element + ' li ul li'), function(ix, el){

                        console.log(element + ' :li click');

                        $(el).on('click', function()
                        {

                            // alert('click on' + element + "::" + (ix - 1));


                        });

                        $(el).hover( function()
                        {

                            $(this).css('background-color', '#003366');

                            $(this).css('color', 'white');

                        }, function(){

                            $(this).css('background-color', 'black');

                            $(this).css('color', 'white');

                        });

                    });


                });

                return html;

            }

    }
        ,


        init:function()
        {


            //request files from the server:





            App.GTUI.renderObjectControllable(Game.sprites[0], $('.selected_object')[0]);




            $(document).on('change', 'input' ,function (e) {



                App.GTUI.renderObjectControllable(Game.sprites[0], $('.selected_object')[0]);


            });



           $(document).on('click', 'li' ,function (e) {
                e.stopPropagation();

                var items = this.getElementsByTagName("ul");

                if (items.length >= 1 && items[0].style.display == "block")
                    $(this).find("ul").slideUp();
                else {

                    $(this).children(":first").slideDown();


                }

            });




            $(document).on('click', 'span.tree-open' ,function (evt) {


                var controllable = $(evt.target).parent().find('ul');


                if($(controllable).length >= 1) {

                    $('ul.controllable ul').toggle('fast');

                    var clPresent = $(evt.target).hasClass('open');

                    if (clPresent) {

                        $(evt.target).animateRotate(180, 90, 250, 'linear', function () {


                            $(evt.target).removeClass('open');

                        });

                    }
                    else {

                        $(evt.target).animateRotate(90, 180, 250, 'linear', function () {


                            $(evt.target).addClass('open');

                        });

                    }

                }


            });




            $(document).on('click', 'img.tree-edit' ,function (evt) {

                $('img.tree-edit').hide();


                $(evt.target).show('fast');

                $(evt.target).css('visibility', 'visible');


                var prt = $(evt.target).parent(),parentObjectName = $(prt).prop('class');

                parentObjectName = parentObjectName.replace('_member', '');

              //  alert(parentObjectName);

                var index = $(prt).index();

              //  alert('Got click on edit button for::' + parentObjectName + ': member number::' + index);

                var selectedObject =  Game.sprites[0][parentObjectName],


                    sprop = selectedObject[index];


              //  alert('index:' + index);

                if(sprop instanceof Animation)
                {

                   // alert(JSON.stringify(sprop));

                    var str = JSON.stringify(sprop);

                 //   alert(str);

                    Game.sprites[0].selected_animation = new Animation(JSON.parse(str));

                    App.selectedItem =  Game.sprites[0].selected_animation;

            }

                if(sprop instanceof Motionstack)
                {

                    Game.sprites[0].selected_motionstack = new Motionstack(sprop);

                    App.selectedItem =  Game.sprites[0].selected_motionstack;

                    sprop = Game.sprites[0].selected_motionstack;

                }


                if(sprop instanceof Force)
                {

                    var str = JSON.stringify(sprop);

                    Game.selected_force = new Force(JSON.parse(str));

                    sprop = Game.selected_force;

                };




                if(sprop){alert('we have an object of:' + sprop.constructor.name);}



                DatGui.get(sprop, index + "");

            });

            $(document).on('click', 'img.tree-delete' ,function (evt) {


                var prt = $(evt.target).parent(),parentObjectName = $(prt).prop('class');

                parentObjectName = parentObjectName.replace('_member', '');


                var index = $(prt).index();

               // alert('Got click on delete button for::' + parentObjectName + ': member number::' + index);

                var selectedObject =  Game.sprites[0];


                var sprop;

                var x = 0;

                Quazar.each(selectedObject[parentObjectName], function(ix, el){

                    if(x == index)
                    {
                       sprop = el;

                    }

                    x+= 1;

                });

            });


            $(document).on('click', 'img.main-play' ,function (evt) {

                App.onType(App.selectedItem, Motionstack, function(){

                    alert('starting motion stack');

                    Game.sprites[0].selected_motionstack.start();

                });

            });


        }

    }



    $(document).ready(function() {
        
        
      


    });


    function animate(time) {

        TWEEN.update(time);


        requestAnimationFrame(animate);


        Game.ctx.clearRect(0, 0, Game.canvas.width, Game.canvas.height);


        Game.render();



    }





    Quazar.ready(function(lib){


      //  alert('hi');


        $.fn.animateRotate = function(startAngle, angle, duration, easing, complete) {
            var args = $.speed(duration, easing, complete);
            var step = args.step;
            return this.each(function(i, e) {
                args.complete = $.proxy(args.complete, e);
                args.step = function(now) {
                    $.style(e, 'transform', 'rotate(' + now + 'deg)');
                    if (step) return step.apply(e, arguments);
                };

                $({deg: startAngle}).animate({deg: angle}, args);
            });
        };



        Game.init();


       App.init();


        animate();

        // var gui = DatGui.get(lib.samples['Animation'][0]);

    });



</script>


</body>
</html>