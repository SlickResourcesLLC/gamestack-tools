"use strict";function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function Squeeze(){this.EffectSequence=EffectSequence,this.each=function(obj,callback){for(var x in obj)callback(x,obj[x])},this.LayeredAnimation=function(animations){console.log("TODO")},this.SequencedAnimation=function(animations){console.log("TODO")}}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),Animation=function(){function Animation(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Animation),args=args||{};this.defaultArgs={name:"my-animation",description:"my-description",frames:[],type:"none",delay:0,frameSize:new Vector3(44,44,0),frameBounds:new VectorFrameBounds(new Vector3(0,0,0),new Vector3(0,0,0),new Vector3(0,0,0)),frameOffset:new Vector3(0,0,0),flipX:!1,duration:1e3,size:new Vector3(20,20,20)};for(var x in this.defaultArgs)args.hasOwnProperty(x)||(args[x]=this.defaultArgs[x]);for(var x in this.args)this[x]=args[x];this.name=args.name||"__",this.description=args.description||"__",this.image=new GameImage(__gameStack.getArg(args,"src",__gameStack.getArg(args,"image",!1))),this.src=this.image.domElement.src,this.domElement=this.image.domElement,this.frameSize=this.getArg(args,"frameSize",new Vector3(44,44,0)),this.frameBounds=this.getArg(args,"frameBounds",new VectorFrameBounds(new Vector3(0,0,0),new Vector3(0,0,0),new Vector3(0,0,0))),this.frameOffset=this.getArg(args,"frameOffset",new Vector3(0,0,0)),this.extras=this.getArg(args,"extras",!1),"object"==("undefined"==typeof args?"undefined":_typeof(args))&&args.frameBounds&&args.frameSize&&this.apply2DFrames(args.parent||{}),this.flipX=this.getArg(args,"flipX",!1),this.cix=0,this.selected_frame=this.frames[0],this.timer=0,this.duration=args.duration||2e3,this.seesaw_mode=args.seesaw_mode||!1}return _createClass(Animation,[{key:"singleFrame",value:function(frameSize,size){return this.__frametype="single",this.frameSize=frameSize,this.size=size||this.frameSize,this.selected_frame={image:this.image,frameSize:this.frameSize,framePos:{x:0,y:0}},this.frames[0]=this.selected_frame,this}},{key:"getArg",value:function(args,key,fallback){return args.hasOwnProperty(key)?args[key]:fallback}},{key:"apply2DFrames",value:function(){this.frames=[];for(var fcount=0,quitLoop=!1,y=this.frameBounds.min.y;y<=this.frameBounds.max.y;y++)for(var x=this.frameBounds.min.x;x<=this.frameBounds.max.x;x++){var framePos={x:x*this.frameSize.x+this.frameOffset.x,y:y*this.frameSize.y+this.frameOffset.y};if(this.frames.push({image:this.image,frameSize:this.frameSize,framePos:framePos}),x>=this.frameBounds.termPoint.x&&y>=this.frameBounds.termPoint.y){quitLoop=!0;break}if(fcount+=1,quitLoop)break}if(this.frames[0]=this.frames[0]?this.frames[0]:{image:this.image,frameSize:this.frameSize,framePos:{x:this.frameBounds.min.x,y:this.frameBounds.min.y}},this.seesaw_mode){console.log("ANIMATION: applying seesaw");var frames_reversed=this.frames.slice().reverse();this.frames.pop(),this.frames=this.frames.concat(frames_reversed)}}},{key:"resetFrames",value:function(){this.apply2DFrames()}},{key:"update",value:function(){this.selected_frame=this.frames[Math.round(this.cix)%this.frames.length]}},{key:"reset",value:function(){this.resetFrames(),this.cix=0}},{key:"continuous",value:function(duration){return"single"==this.__frametype?0:(this.apply2DFrames(),this.update(),void(0==this.cix&&this.engage()))}},{key:"engage",value:function(duration,complete){if("single"==this.__frametype)return 0;var __inst=this;this.complete=complete||this.complete||function(){},duration=duration||"number"==typeof this.duration?this.duration:20*this.frames.length,0==this.cix&&this.extras&&this.extras.call(),this.tween=new TWEEN.Tween(this).easing(__inst.curve||TWEEN.Easing.Linear.None).to({cix:__inst.frames.length-1},duration).onUpdate(function(){__inst.update()}).onComplete(function(){__inst.complete&&__inst.complete(),__inst.cix=0,__inst.isComplete=!0}),this.tween.start()}},{key:"onComplete",value:function(fun){this.complete=fun}},{key:"animate",value:function(){this.apply2DFrames(),this.timer+=1,0!=this.delay&&this.timer%this.delay!=0||(0==this.cix&&this.extras&&this.extras.call(),this.cix>=this.frames.length-1&&"function"==typeof this.complete&&this.complete(this),this.cix=this.cix>=this.frames.length-1?this.frameBounds.min.x:this.cix+1,this.update())}}]),Animation}();Gamestack.Animation=Animation;var EffectSequence=function(){function EffectSequence(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,EffectSequence),console.log("Effect Sequence");for(var x in args)this[x]=args[x];this.animation=args.animation||!1,this.name=args.name||"__none",this.effects=Gamestack.JSManipulate,this.setEffect(args.selected_effect_key||args.selected_effect||this.effects.triangleripple),console.log("created effect of: "+this.getSelectedEffectKey()),this.effects_list=[],this.effects_list[0]=this.selected_effect,this.effect_guis=[],this.numberSteps=10,this.curve=args.curve||TWEEN.Easing.Linear.None,this.counter=0,this.duration=3e3,this.seesaw_mode=args.seesaw_mode||!0,this.canvas=document.createElement("canvas"),this.testCtx=this.canvas.getContext("2d"),this.values={},this.initValues(args),this.minFloat=function(portion){for(var x in this.startValues)this.startValues[x]=this.valueRanges[x].max*portion},this.maxFloat=function(portion){for(var x in this.endValues)this.endValues[x]=this.valueRanges[x].max*portion},this.iterables={__canvasList:[],__dataList:[]}}return _createClass(EffectSequence,[{key:"getSelectedEffectKey",value:function(){return this.selected_effect_key}},{key:"setEffect",value:function(effect){for(var x in this.effects)x!=effect&&effect!=this.effects[x]||(this.selected_effect_key=x,this.selected_effect=this.effects[x],this.effects_list=[],this.effects_list[0]=this.selected_effect)}},{key:"initValues",value:function(args){this.startValues=args.startValues||{},this.endValues=args.endValues||{};for(var x in this.selected_effect.valueRanges)"number"!=typeof this.startValues[x]&&(this.startValues[x]=this.selected_effect.valueRanges[x].min,this.endValues[x]=this.selected_effect.valueRanges[x].max);this.values=JSON.parse(jstr(this.startValues)),this.valueRanges=this.selected_effect.valueRanges}},{key:"ondone",value:function(){}},{key:"onerror",value:function(){}},{key:"onchunk",value:function(){}},{key:"apply",value:function(sprite,canvas,completeCallback){function copyImageData(ctx,src){var dst=ctx.createImageData(src.width,src.height);return dst.data.set(src.data),dst}function callCompletion(){__inst.ondone&&__inst.ondone(__inst.iterables),completeCallback&&completeCallback(__inst.image_data_list)}function frameToCanvas(img){if(!__inst.iterables.__canvasList[__inst.counter]){var c=document.createElement("CANVAS"),ct=c.getContext("2d");c.width=__inst.source_image.width,c.height=__inst.source_image.height,c.style.background="blue",ct.restore(),ct.save(),ct.putImageData(img,0,0),__inst.iterables.__canvasList.push(c),__inst.iterables.__dataList.push(img),__inst.onchunk&&__inst.onchunk(c,img)}}var __inst=this;__inst.sprite=sprite,__inst.canvas=canvas;if(0==this.counter&&canvas&&this.selected_effect&&this.selected_effect.hasOwnProperty("filter")){this.timer_diff=0;var ctx=canvas.getContext("2d");__inst.values=JSON.parse(jstr(__inst.startValues));new TWEEN.Tween(this.values).to(this.endValues,this.duration).easing(this.curve).onUpdate(function(){__inst.source_image||(__inst.source_image=ctx.getImageData(sprite.position.x,sprite.position.y,sprite.size.x,sprite.size.y),console.log("image is set"));var img=copyImageData(ctx,__inst.source_image);__inst.selected_effect.filter(img,__inst.values),sprite.selected_animation.selected_frame.image.data=img,frameToCanvas(img),__inst.counter+=1}).onComplete(function(){if(__inst.seesaw_mode){new TWEEN.Tween(__inst.values).to(__inst.startValues,__inst.duration).easing(__inst.curve).onUpdate(function(){__inst.source_image||(__inst.source_image=ctx.getImageData(sprite.position.x,sprite.position.y,sprite.size.x,sprite.size.y),console.log("image is set"));var img=copyImageData(ctx,__inst.source_image);__inst.selected_effect.filter(img,__inst.values),sprite.selected_animation.selected_frame.image.data=img,frameToCanvas(img),__inst.counter+=1}).onComplete(function(){callCompletion(__inst.source_image),__inst.counter=0}).start()}else callCompletion(__inst.source_image),__inst.counter=0}).start()}}}]),EffectSequence}(),Rectangle=function Rectangle(min,max){_classCallCheck(this,Rectangle),this.min=min,this.max=max},VectorBounds=Rectangle;Gamestack.Rectangle=Rectangle;var VectorFrameBounds=function(_Rectangle){function VectorFrameBounds(min,max,termPoint){_classCallCheck(this,VectorFrameBounds);var _this=_possibleConstructorReturn(this,(VectorFrameBounds.__proto__||Object.getPrototypeOf(VectorFrameBounds)).call(this,min,max));return _this.termPoint=termPoint||new Vector3(_this.max.x,_this.max.y,_this.max.z),_this}return _inherits(VectorFrameBounds,_Rectangle),VectorFrameBounds}(Rectangle);Gamestack.VectorFrameBounds=VectorFrameBounds;var Curves={linearNone:function(t){return t},easeInQuadratic:function(t){return t*t},easeOutQuadratic:function(t){return t*(2-t)},easeInOutQuadratic:function(t){return t<.5?2*t*t:-1+(4-2*t)*t},easeInCubic:function(t){return t*t*t},easeOutCubic:function(t){return--t*t*t+1},easeInOutCubic:function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},easeInQuartic:function(t){return t*t*t*t},easeOutQuartic:function(t){return 1- --t*t*t*t},easeInOutQuartic:function(t){return t<.5?8*t*t*t*t:1-8*--t*t*t*t},easeInQuintic:function(t){return t*t*t*t*t},easeOutQuintic:function(t){return 1+--t*t*t*t*t},easeInOutQuintic:function(t){return t<.5?16*t*t*t*t*t:1+16*--t*t*t*t*t}};Gamestack.Curves=Curves;var Line=function(){function Line(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Line),this.curve_string=args.curve_string||"Linear_None",this.curve=this.get_curve_from_string(this.curve_string),this.motion_curve=args.motion_curve||TWEEN.Easing.Linear.None,"function"==typeof args.curve&&(this.curve=args.curve),this.points=[],this.position=args.position||new Vector,this.is_highlighted=args.is_highlighted||!1,this.offset=args.offset||new Vector,this.pointDist=5,this.size=args.size||new Vector,this.rotation=args.rotation||0,this.iterations=1,this.growth=args.growth||1.2,this.curve_options=Curves}return _createClass(Line,[{key:"Iterations",value:function(n){return this.iterations=n,this}},{key:"Growth",value:function(n){return this.growth=n,this}},{key:"Pos",value:function(p){return this.position=p,this}},{key:"PointDisp",value:function(num){return this.minPointDist=num,this}},{key:"Curve",value:function(c){return this.curve=c,this.curve_string=this.get_curve_string(c),this}},{key:"Duration",value:function(d){return this.duration=d,this}},{key:"get_curve_from_string",value:function(str){for(var x in this.curve_options)if(x.toLowerCase()==str.toLowerCase().replace("_",""))return this.curve_options[x]}},{key:"get_curve_string",value:function(c){for(var x in this.curve_options)if(this.curve_options[x]==c)return x}},{key:"getGraphCanvas",value:function(curveCall,existing_canvas){var canvas=existing_canvas||document.createElement("canvas");canvas.style.position="relative",canvas.id="curve-display",canvas.setAttribute("class","motion-curve"),canvas.width=180,canvas.height=100,canvas.style.background="black";var context=canvas.getContext("2d");context.fillStyle="rgb(0,0,0)",context.fillRect(0,0,180,100),context.lineWidth=.5,context.strokeStyle="rgb(230,230,230)",context.beginPath(),context.moveTo(0,20),context.lineTo(180,20),context.moveTo(0,80),context.lineTo(180,80),context.closePath(),context.stroke(),context.lineWidth=2,context.strokeStyle="rgb(255,127,127)";var position={x:0,y:80},position_old={x:0,y:80};this.test_graph_size=new Vector(185,60);var points=this.get_line_segment(this.test_graph_size,5,curveCall);for(var x in points){var position=new Vector(points[x].x,this.test_graph_size.y+20-points[x].y);context.beginPath(),context.moveTo(position_old.x,position_old.y),context.lineTo(position.x,position.y),context.closePath(),context.stroke(),position_old.x=position.x,position_old.y=position.y}return canvas}},{key:"get_line_segment",value:function(size,pointDist,curveCall){if(!size||!pointDist)return 0;var points=[],current_point=new Vector(0,0,0),position=new Vector(current_point),target=new Vector(position.add(size)),start=new Vector(position),curveMethod=curveCall,ptrack=new Vector(start);for(position.x=position.x;position.x<target.x;position.x+=1){var dist=position.sub(start),pct=dist.x/size.x;if(console.log(pct),position.y=Math.round(curveMethod(pct)*size.y),ptrack.trig_distance_xy(position)>=pointDist){var p=new Vector(Gamestack.GeoMath.rotatePointsXY(position.x,position.y,0));points.push(p),current_point=new Vector(position),ptrack=new Vector(current_point)}}return points}},{key:"fill",value:function(size,pointDist){if(!size||!pointDist)return 0;this.size=size,this.pointDist=pointDist;this.points=[];for(var current_point=new Vector(this.position),x=0;x<=this.iterations;x++){var position=new Vector(current_point),target=new Vector(position.add(size)),start=new Vector(position),curveMethod=this.curve;new Vector(start);for(position.x=position.x;position.x<target.x;position.x+=1){var dist=position.sub(start),pct=dist.x/size.x;if(position.y=start.y+Math.round(curveMethod(pct)*size.y),current_point.trig_distance_xy(position)>=this.pointDist){var p=new Vector(Gamestack.GeoMath.rotatePointsXY(position.x,position.y,this.rotation));this.points.push(p),current_point=new Vector(position)}}size=size.mult(this.growth)}}},{key:"transpose",value:function(origin){for(var t_points=[],x=0;x<this.points.length;x++)t_points.push(this.points[x].add(origin));return t_points}},{key:"add_segment",value:function(next_segment,offset){for(var x=0;x<next_segment.length;x++)next_segment[x]=new Vector(next_segment[x]).add(offset),this.points.push(next_segment[x])}},{key:"get_flipped_segment",value:function(points){for(var t_points=points.slice(),t_len=t_points.length,x=0;x<points.length;x++)t_points[t_len-x].x=points[x].x;return t_points}},{key:"Highlight",value:function(origin,ctx){ctx=ctx||Gamestack.ctx;for(var x in this.points){var point=origin.add(this.points[x]).sub(Gamestack.point_highlighter.size.mult(.5)),dist=point.sub(Gamestack.point_highlighter.position),d=Math.sqrt(dist.x*dist.x+dist.y*dist.y);d>=10&&(Gamestack.point_highlighter.position=new Vector2(origin.add(this.points[x]).sub(Gamestack.point_highlighter.size.mult(.5)))),Canvas.draw(Gamestack.point_highlighter,ctx)}return this}}]),Line}(),GeoMath={rotatePointsXY:function(x,y,angle){var theta=angle*Math.PI/180,point={};return point.x=x*Math.cos(theta)-y*Math.sin(theta),point.y=x*Math.sin(theta)+y*Math.cos(theta),point.z=0,point}};Gamestack.GeoMath=GeoMath;var Sprite=function(){function Sprite(args){_classCallCheck(this,Sprite),args||(args={}),args instanceof Animation&&(args={selected_animation:args,size:new Vector(args.frameSize)}),this.active=!0,this.name=args.name||"__",this.description=args.description||"__",this.gravity="medium",this.__initializers=__gameStack.getArg(args,"__initializers",[]);var _spr=this;Gamestack.each(args,function(ix,item){"parent"!==ix&&(_spr[ix]=item)}),this.type=__gameStack.getArg(args,"type","basic"),this.animations=__gameStack.getArg(args,"animations",[]),this.motions=__gameStack.getArg(args,"motions",[]),this.projectiles=__gameStack.getArg(args,"projectiles",[]);var __inst=this;this.id=__gameStack.getArg(args,"id",this.create_id()),this.sounds=__gameStack.getArg(args,"sounds",[]),this.image=new GameImage(__gameStack.getArg(args,"src",__gameStack.getArg(args,"image",!1))),this.size=new Vector(__gameStack.getArg(args,"size",new Vector3(100,100))),this.position=new Vector(__gameStack.getArg(args,"position",new Vector3(0,0,0))),this.collision_bounds=__gameStack.getArg(args,"collision_bounds",new VectorBounds(new Vector3(0,0,0),new Vector3(0,0,0))),this.rotation=new Vector(__gameStack.getArg(args,"rotation",new Vector3(0,0,0))),this.selected_animation={},this.speed=__gameStack.getArg(args,"speed",new Vector3(0,0,0)),this.acceleration=__gameStack.getArg(args,"acceleration",new Vector3(0,0,0)),this.rot_speed=__gameStack.getArg(args,"rot_speed",new Vector3(0,0,0)),this.rot_accel=__gameStack.getArg(args,"rot_accel",new Vector3(0,0,0)),this.padding=__gameStack.getArg(args,"padding",new Vector3(0,0,0)),GameStack.each(this.sounds,function(ix,item){__inst.sounds[ix]=new Sound(item)}),GameStack.each(this.motions,function(ix,item){__inst.motions[ix]=new Motion(item)}),GameStack.each(this.animations,function(ix,item){__inst.animations[ix]=new Animation(item)}),GameStack.each(this.projectiles,function(ix,item){__inst.projectiles[ix]=new Projectile(item)}),GameStack.each(this.__initializers,function(ix,item){__inst.onInit(item)}),args.selected_animation?this.selected_animation=new Animation(args.selected_animation):this.image.domElement.onload=function(){__inst.setAnimation(__inst.animations[0]||new Animation({image:__inst.image,frameSize:new Vector3(__inst.image.domElement.width,__inst.image.domElement.height),frameBounds:new VectorFrameBounds(new Vector3,new Vector3)}))}}return _createClass(Sprite,[{key:"init",value:function(){}},{key:"onInit",value:function(fun){if("string"==typeof fun){this.__initializers.indexOf(fun)<0&&this.__initializers.push(fun);var __inst=this,keys=fun.split(".");if(console.log("finding init from string:"+fun),!keys.length>=2)return console.error('need min 2 string keys separated by "."');var f=GameStack.options.SpriteInitializers[keys[0]][keys[1]];if("function"==typeof f){var __inst=this,f_init=this.init;this.init=function(){f_init(__inst),f(__inst)}}}else if("function"==typeof fun){console.log("extending init:");var f_init=this.init,__inst=this;this.init=function(){f_init(__inst),fun(__inst)}}else"object"==("undefined"==typeof fun?"undefined":_typeof(fun))&&(console.log("extending init:"),console.info("Quick2D does not yet implement onInit() from arg of object type"))}},{key:"get_id",value:function(){return this.id}},{key:"to_map_object",value:function(size,framesize){return this.__mapSize=new Vector3(size||this.size),this.frameSize=new Vector3(framesize||this.size),this}},{key:"create_id",value:function(){return Quick2d.create_id()}},{key:"setSize",value:function(size){this.size=new Vector3(size.x,size.y,size.z)}},{key:"setPos",value:function(pos){this.position=new Vector3(pos.x,pos.y,pos.z||0)}},{key:"getCappedSizeXY",value:function(mx,my,currentSize){var size=new Vector3(currentSize||this.size),wth=size.y/size.x,htw=size.x/size.y;return size.x>mx&&(size.x=mx,size.y=size.x*wth),size.y>my&&(size.y=my,size.x=size.y*htw),size}},{key:"assertSpeed",value:function(){this.speed||(this.speed=new Vector3(0,0,0))}},{key:"setAnimation",value:function(anime){return anime instanceof Animation&&this.animations.indexOf(anime)<0&&this.animations.push(anime),this.selected_animation=anime,Gamestack.log("declared default animation"),this}},{key:"onScreen",value:function onScreen(w,h){w=w||__gameStack.WIDTH,h=h||__gameStack.HEIGHT;var camera=__gameStack.camera||__gameStack.__gameWindow.camera||new Vector3(0,0,0),p=new Vector3(this.position.x-camera.position.x,this.position.y-camera.position.y,this.position.z-camera.position.z),onScreen=p.x>0-this.size.x&&p.x<w+this.size.x&&p.y>0-this.size.x&&p.y<h+this.size.y;return onScreen}},{key:"update",value:function(sprite){}},{key:"def_update",value:function(sprite){for(var x in this.speed)(this.speed[x]>0||this.speed[x]<0)&&(this.position[x]+=this.speed[x]);for(var x in this.acceleration)(this.acceleration[x]>0||this.acceleration[x]<0)&&(this.speed[x]+=this.acceleration[x]);for(var x in this.rot_speed)(this.rot_speed[x]>0||this.rot_speed[x]<0)&&(this.rotation[x]+=this.rot_speed[x]);for(var x in this.rot_accel)(this.rot_accel[x]>0||this.rot_accel[x]<0)&&(this.rot_speed[x]+=this.rot_accel[x])}},{key:"resolveFunctionFromDoubleKeys",value:function(keyString1,keyString2,obj,callback){callback("function"==typeof obj[keyString1][keyString2]?obj[keyString1][keyString2]:{})}},{key:"extendFunc",value:function(fun,extendedFunc){console.log("extending func");var ef=extendedFunc,__inst=this;return function(){ef(__inst),fun(__inst)}}},{key:"onUpdate",value:function(fun){fun=fun||function(){};var update=this.update;this.update=function(__inst){update(__inst),fun(__inst)}}},{key:"collidesRectangular",value:function(sprite){return Gamestack.Collision.spriteRectanglesCollide(this,sprite)}},{key:"shoot",value:function(options){this.prep_key="shoot";var animation=options.bullet||options.animation||new Animation,speed=options.speed||1,position=options.position||new Vector3(this.position),size=options.size||new Vector3(10,10,0),rot_offset=options.rot_offset||new Vector3(0,0,0);if(__gameInstance.isAtPlay){var bx=position.x,by=position.y,shot=(size.x,size.y,__gameStack.add(new Sprite({active:!0,position:position,size:size,image:animation.image,rotation:new Vector3(0,0,0),flipX:!1})));return shot.setAnimation(animation),"number"==typeof rot_offset&&(rot_offset=new Vector3(rot_offset,0,0)),shot.position.x=bx,shot.position.y=by,shot.rotation.x=0+rot_offset.x,shot.stats={damage:1},shot.speed.x=Math.cos(3.14*shot.rotation.x/180)*speed,shot.speed.y=Math.sin(3.14*shot.rotation.x/180)*speed,shot}return new Error("game was not in motion: Gamestack.isAtPlay must be true to create a shot.")}},{key:"subsprite",value:function subsprite(options){var animation=options.animation||new Animation,position=options.position||new Vector3(this.position),offset=options.offset||new Vector3(0,0,0),size=options.size||this.size;if(__gameInstance.isAtPlay){var subsprite=__gameStack.add(new Sprite({active:!0,position:position,size:size,offset:offset,image:animation.image,rotation:new Vector3(0,0,0),flipX:!1}));return subsprite.setAnimation(animation),subsprite}alert("No subsprite when not at play")}},{key:"animate",value:function(animation){__gameInstance.isAtPlay&&(animation&&this.setAnimation(animation),this.selected_animation.animate())}},{key:"onAnimationComplete",value:function(fun){this.selected_animation.onComplete(fun)}},{key:"accelY",value:function(accel,max){accel=Math.abs(accel),"number"==typeof max&&(max={y:max}),this.assertSpeed();var diff=max.y-this.speed.y;diff>0&&(this.speed.y+=Math.abs(diff)>=accel?accel:diff),diff<0&&(this.speed.y-=Math.abs(diff)>=accel?accel:diff)}},{key:"accelX",value:function(accel,max){accel=Math.abs(accel),"number"==typeof max&&(max={x:max}),this.assertSpeed();var diff=max.x-this.speed.x;diff>0&&(this.speed.x+=Math.abs(diff)>=accel?accel:diff),diff<0&&(this.speed.x-=Math.abs(diff)>=accel?accel:diff)}},{key:"accel",value:function(prop,key,_accel,max){_accel=Math.abs(_accel),"number"==typeof max&&(max={x:max});var diff=(prop[key],max.x-prop[key]);diff>0&&(prop[key]+=Math.abs(diff)>=_accel?_accel:diff),diff<0&&(prop[key]-=Math.abs(diff)>=_accel?_accel:diff)}},{key:"decel",value:function(prop,key,rate){"object"==("undefined"==typeof rate?"undefined":_typeof(rate))&&(rate=rate.rate),rate=Math.abs(rate),Math.abs(prop[key])<=rate?prop[key]=0:prop[key]>0?prop[key]-=rate:prop[key]<0?prop[key]+=rate:prop[key]=0}},{key:"decelY",value:function(amt){amt=Math.abs(amt),Math.abs(this.speed.y)<=amt?this.speed.y=0:this.speed.y>amt?this.speed.y-=amt:this.speed.y<amt*-1&&(this.speed.y+=amt)}},{key:"decelX",value:function(amt){amt=Math.abs(amt),this.speed.x>amt?this.speed.x-=amt:this.speed.x<amt*-1&&(this.speed.x+=amt),Math.abs(this.speed.x)<=amt&&(this.speed.x=0)}},{key:"shortest_stop",value:function(item,callback){var diff_min_y=item.min?item.min.y:Math.abs(item.position.y-this.position.y+this.size.y),diff_min_x=item.min?item.min.x:Math.abs(item.position.x-this.position.x+this.size.x),diff_max_y=item.max?item.max.y:Math.abs(item.position.y+item.size.y-this.position.y),diff_max_x=item.max?item.max.x:Math.abs(item.position.x+item.size.x-this.position.y),dimens={top:diff_min_y,left:diff_min_x,bottom:diff_max_y,right:diff_max_x},minkey="",min=1e7;for(var x in dimens)dimens[x]<min&&(min=dimens[x],minkey=x);callback(minkey)}},{key:"center",value:function(){return new Vector(this.position.x+this.size.x/2,this.position.y+this.size.y/2,0)}},{key:"overlap_x",value:function(item,padding){padding||(padding=0);var paddingX=Math.round(padding*this.size.x),paddingY=Math.round(padding*this.size.y),left=this.position.x+paddingX,right=this.position.x+this.size.x-paddingX;this.position.y+paddingY,this.position.y+this.size.y-paddingY;return right>item.position.x&&left<item.position.x+item.size.x}},{key:"overlap_y",value:function(item,padding){padding||(padding=0);var paddingX=Math.round(padding*this.size.x),paddingY=Math.round(padding*this.size.y),top=(this.position.x+paddingX,this.position.x+this.size.x-paddingX,this.position.y+paddingY),bottom=this.position.y+this.size.y-paddingY;return bottom>item.position.y&&top<item.position.y+item.size.y}},{key:"collide_stop_x",value:function(item){for(var apart=!1,ct=1e4;!apart&&ct>0;){ct--;var diffX=this.center().sub(item.center()).x,distX=Math.abs(this.size.x/2+item.size.x/2-Math.round(this.size.x*this.padding.x));Math.abs(diffX)<distX?this.position.x-=diffX>0?-1:1:apart=!0}}},{key:"collide_stop",value:function(item){if(this.id==item.id)return!1;if(this.collidesRectangular(item)){var diff=this.center().sub(item.center());if(this.overlap_x(item,this.padding.x+.1)&&Math.abs(diff.x)<Math.abs(diff.y))for(var apart=!1,ct=1e4;!apart&&ct>0;){ct--;var diffY=this.center().sub(item.center()).y,distY=Math.abs(this.size.y/2+item.size.y/2-Math.round(this.size.y*this.padding.y));if(!(Math.abs(diffY)<distY))return diffY<=0&&(this.__inAir=!1),apart=!0;this.position.y-=diffY>0?-1:diffY<0?1:0,this.position.y=Math.round(this.position.y)}this.overlap_y(item,this.padding.y)&&Math.abs(diff.y)<Math.abs(diff.x)&&this.collide_stop_x(item)}}},{key:"collide_stop_top",value:function(item){if(this.id==item.id)return!1;if(this.overlap_x(item,this.padding.x+.1)){console.log("OVERLAP_X");var paddingY=this.padding.y*this.size.y;this.position.y+this.size.y-paddingY<=item.position.y&&(this.groundMaxY=item.position.y-this.size.y+paddingY)}}},{key:"restoreFrom",value:function(data){return data.image=new GameImage(data.src||data.image.src),new Sprite(data)}},{key:"fromFile",value:function(file_path){if("string"==typeof file_path){var __inst=this;$.getJSON(file_path,function(data){__inst=new Sprite(data)})}}}]),Sprite}();Gamestack.Sprite=Sprite;var SpriteInitializersOptions={Clastics:{top_collideable:function(sprite){for(var x in Gamestack.__gameWindow.forces){var force=Gamestack.__gameWindow.forces[x];force.topClastics.push(sprite)}sprite.onUpdate(function(){})},fourside_collideable:function(sprite){for(var x in Gamestack.__gameWindow.forces){var force=Gamestack.__gameWindow.forces[x];force.clasticObjects.push(sprite)}sprite.onUpdate(function(){})}},MainGravity:{very_light:function(sprite){Gamestack.add(new Force({name:"very_light_grav",accel:.05,max:new Vector3(0,3.5,0),subjects:[sprite],clasticObjects:[]}));sprite.onUpdate(function(){})},light:function(sprite){Gamestack.add(new Force({name:"light_grav",accel:.1,max:new Vector3(0,4.5,0),subjects:[sprite],clasticObjects:[]}));sprite.onUpdate(function(){})},medium:function(sprite){Gamestack.add(new Force({name:"medium_grav",accel:.2,max:new Vector3(0,7.5,0),subjects:[sprite],clasticObjects:[]}));sprite.onUpdate(function(){})},strong:function(sprite){Gamestack.add(new Force({name:"strong_grav",accel:.4,max:new Vector3(0,10.5,0),subjects:[sprite],clasticObjects:[]}));sprite.onUpdate(function(){})},very_strong:function(sprite){Gamestack.add(new Force({name:"strong_grav",accel:.5,max:new Vector3(0,12.5,0),subjects:[sprite],clasticObjects:[]}));sprite.onUpdate(function(){})}},ControllerStickMotion:{player_move_x:function(sprite){alert("applying initializer"),console.log("side_scroll_player_run:init-ing");Gamestack||Quick2d;Gamestack.GamepadAdapter.on("stick_left",0,function(x,y){if(console.log("stick-x:"+x),Math.abs(x)<.2)return 0;var accel=.2,max=7;sprite.accelX(accel,x*max),x<-.2?sprite.flipX=!0:x>.2&&(sprite.flipX=!1)}),sprite.onUpdate(function(spr){spr.decelX(.1),spr.__falling||spr.decelY(.2)})},player_move_xy:function(sprite){alert("applying initializer"),console.log("side_scroll_player_run:init-ing");Gamestack||Quick2d;Gamestack.GamepadAdapter.on("stick_left",0,function(x,y){console.log("stick-x:"+x),Math.abs(x)<.2&&(x=0),Math.abs(y)<.2&&(y=0);var accel=.2,max=7;sprite.accelX(accel,x*max),sprite.accelY(accel,y*max),x<-.2?sprite.flipX=!0:x>.2&&(sprite.flipX=!1)}),sprite.onUpdate(function(spr){sprite.decel(sprite.speed,"x",.1),sprite.decel(sprite.speed,"y",.1)})},player_rotate_x:function(sprite){Gamestack||Quick2d;Gamestack.GamepadAdapter.on("stick_left",0,function(x,y){if(console.log("stick-x:"+x),Math.abs(x)<.2)return 0;var accel=.25,max=7;sprite.accel(sprite.rot_speed,"x",accel,x*max),x<-.2?sprite.flipX=!0:x>.2&&(sprite.flipX=!1)}),sprite.onUpdate(function(spr){sprite.decel(sprite.rot_speed,"x",.1),spr.__falling||spr.decelY(.2)})}}};Gamestack.options=Gamestack.options||{},Gamestack.options.SpriteInitializers=SpriteInitializersOptions;var Vector=function(){function Vector(x,y,z,r){return _classCallCheck(this,Vector),"object"==("undefined"==typeof x?"undefined":_typeof(x))&&x.hasOwnProperty("x")&&x.hasOwnProperty("y")?(this.x=x.x,this.y=x.y,this.z=x.z||0,null==this.z&&(this.z=0),this):(null==z&&(z=0),this.x=x,this.y=y,this.z=z,void(this.r=r))}return _createClass(Vector,[{key:"sub",value:function(v){return"number"==typeof v&&(v={x:v,y:v,z:v}),new Vector(this.x-v.x,this.y-v.y,this.z-v.z)}},{key:"add",value:function(v){return"number"==typeof v&&(v={x:v,y:v,z:v}),new Vector(this.x+v.x,this.y+v.y,this.z+v.z)}},{key:"mult",value:function(v){return"number"==typeof v&&(v={x:v,y:v,z:v}),new Vector(this.x*v.x,this.y*v.y,this.z*v.z)}},{key:"div",value:function(v){return"number"==typeof v&&(v={x:v,y:v,z:v}),new Vector(this.x/v.x,this.y/v.y,this.z/v.z)}},{key:"round",value:function(){return new Vector(Math.round(this.x),Math.round(this.y),Math.round(this.z))}},{key:"floor",value:function(){return new Vector(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z))}},{key:"ceil",value:function(){return new Vector(Math.ceil(this.x),Math.ceil(this.y),Math.ceil(this.z))}},{key:"equals",value:function(v){return this.x==v.x&&this.y==v.y&&this.z==v.z}},{key:"trig_distance_xy",value:function(v){var dist=this.sub(v);return Math.sqrt(dist.x*dist.x+dist.y*dist.y)}},{key:"diff",value:function(){}},{key:"abs_diff",value:function(){}
},{key:"is_between",value:function(v1,v2){return this.x>=v1.x&&this.x<=v2.x&&this.y>=v1.y&&this.y<=v2.y&&this.z>=v1.z&&this.z<=v2.z}}]),Vector}(),Vector3=Vector,Pos=Vector,Size=Vector,Position=Vector,Vector2=Vector,Rotation=Vector;Gamestack.Vector=Vector;var AsyncSteps=function AsyncSteps(mainObject,options){_classCallCheck(this,AsyncSteps);var ondone=(options.error||options.err||options.onerror,options.done||options.ondone),chunk=options.chunk||options.onchunk,promise=new Promise(function(done,error){mainObject.onerror=function(){return error(mainObject.__errorMessage)},mainObject.onchunk=function(){return chunk(mainObject.iterables)},mainObject.ondone=function(){return ondone(mainObject.iterables)}});this.__promise=promise};